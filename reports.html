<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Inventory Report â€” AJMZ & CALIBRATE</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#F5F5F0; --panel:#E6D8C3; --accent:#5D866C; --accent-2:#C2A68C;
  --ink:#2f3b33; --muted:#6b776f; --line:#d9cbb1; --shadow:rgba(93,134,108,.18);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:Inter,system-ui;background:var(--bg);color:var(--ink);
  display:flex;height:100vh;overflow:hidden;
}

/* NAV (same feel as sell.html) */
.nav-vertical{
  width:60px;background:#fff;border-right:3px solid var(--accent-2);
  display:flex;flex-direction:column;align-items:center;padding:14px 0;gap:20px;
  box-shadow:6px 0 20px var(--shadow);position:fixed;left:0;top:0;bottom:0;z-index:2000
}
.nav-item{
  width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;
  font-size:22px;text-decoration:none;color:var(--ink);
  background:#fff;border:1px solid var(--line);cursor:pointer;font-weight:600
}
.nav-item.active{background:var(--accent);color:#fff;border-color:transparent}

/* PAGE */
.right{flex:1;display:flex;flex-direction:column;margin-left:60px;padding:10px;gap:12px;min-width:0}
.header{display:flex;align-items:center;gap:10px}
.title{font-weight:700;color:var(--accent)}
.spacer{flex:1}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:600;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border:none}

/* PANELS */
.panel{
  background:#fff;border:1px solid var(--line);border-radius:14px;
  box-shadow:0 8px 24px var(--shadow);display:flex;flex-direction:column;padding:12px;gap:10px
}
.head{font-weight:600;color:var(--accent)}

/* SLICER BAR (Google Sheets style) */
.slicer-bar{display:flex;flex-wrap:wrap;gap:8px}
.slicer{
  position:relative;
}
.slicer-btn{
  display:flex;align-items:center;gap:6px;
  padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600;font-size:12px
}
.slicer-btn:after{content:"â–¾";opacity:.8}
.slicer-menu{
  position:absolute;top:44px;left:0;z-index:3000;width:260px;
  background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 28px var(--shadow);
  display:none;flex-direction:column;max-height:340px;overflow:hidden;
}
.slicer.open .slicer-menu{display:flex}
.slicer-head{padding:8px;border-bottom:1px solid var(--line);display:flex;gap:6px;align-items:center}
.slicer-head input{flex:1;padding:6px;border:1px solid var(--line);border-radius:8px;font-size:12px}
.slicer-actions{padding:6px 8px;display:flex;gap:8px}
.slicer-actions .a{font-size:12px;color:var(--accent);cursor:pointer;text-decoration:underline}
.slicer-list{overflow:auto}
.slicer-item{display:flex;gap:8px;align-items:center;padding:6px 10px;border-bottom:1px solid #f1eadb;font-size:12px}
.slicer-foot{padding:8px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

/* DATE BOX */
.date-box{display:flex;gap:6px;align-items:center}
.date-box input{padding:6px;border:1px solid var(--line);border-radius:8px;font-size:12px}

/* PILLS (optional quick view) */
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{background:#f3efe6;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
.pill .x{cursor:pointer;margin-left:6px}

/* TABLES */
.table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:12px}
th{background:var(--panel);padding:8px;text-align:left;position:sticky;top:0;border-bottom:1px solid var(--line)}
td{padding:8px;border-bottom:1px solid #e9dec9;text-align:left}
tbody tr:hover{background:#faf8f0}
.mono{font-family:ui-monospace,Consolas;text-align:right}

/* Row coloring for clarity */
tr.sell td{color:#9b2c2c}     /* sell rows reddish */
tr.add td{color:#2f3b33}

/* TOTALS (visible only) */
.totals-bar{
  display:flex;gap:12px;justify-content:flex-end;align-items:center;
  padding:8px 10px;border-top:1px solid var(--line);background:#fff;border-radius:0 0 12px 12px
}
.pill-sum{background:#f3efe6;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:700}

/* PRINT */
@media print{
  .nav-vertical,.header,.panel.filters,.pills,.slicer-menu{display:none!important}
  .panel{box-shadow:none;border-color:#bbb}
}
</style>
</head>
<body>

<!-- NAV -->
<div class="nav-vertical">
  <a href="index.html" class="nav-item">ðŸ‘¤</a>
  <a href="add.html" class="nav-item">âž•</a>
  <a href="sell.html" class="nav-item">ðŸ’Ž</a>
  <a href="reports.html" class="nav-item active">ðŸ“Š</a>
</div>

<div class="right">

  <div class="header">
    <div class="title">Inventory Report â€” ADD & SELL</div>
    <div class="spacer"></div>
    <button class="btn" id="btnExport">Export CSV</button>
    <button class="btn" id="btnPrint">Print</button>
    <button class="btn primary" id="btnClear">Clear Filters</button>
  </div>

  <!-- Filters: Slicer bar -->
  <div class="panel filters">
    <div class="head">Filters</div>
    <div class="slicer-bar" id="slicerBar">
      <!-- slicers are injected -->
    </div>
    <div class="date-box">
      <b>Date:</b>
      <input type="date" id="f_date_from">
      <span>to</span>
      <input type="date" id="f_date_to">
    </div>
    <div class="pills" id="pills"></div>
  </div>

  <!-- Ledger -->
  <div class="panel">
    <div class="head">Movement Ledger (visible rows only)</div>
    <div class="table-wrap">
      <table id="tblMov">
        <thead>
          <tr>
            <th>Movement</th>
            <th>Stone</th>
            <th>Transaction No</th>
            <th>Date</th>
            <th>Party</th>
            <th>Lot</th>
            <th>Lot No / Grade</th>
            <th>Shape</th>
            <th>Size</th>
            <th class="mono">PCS</th>
            <th class="mono">CTS</th>
            <th class="mono">Rate</th>
            <th class="mono">Amount</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="totals-bar" id="movTotals">
      <span class="pill-sum">PCS: <span id="sumPCS">0</span></span>
      <span class="pill-sum">CTS: <span id="sumCTS">0.00</span></span>
      <span class="pill-sum">Amount: <span id="sumAMT">0.00</span></span>
    </div>
  </div>

  <!-- Balance -->
  <div class="panel">
    <div class="head">Remaining Balances (ADD âˆ’ SELL) â€” Grouped by Stone + Lot + LotNo/Grade</div>
    <div class="table-wrap">
      <table id="tblBal">
        <thead>
          <tr>
            <th>Stone</th>
            <th>Lot</th>
            <th>Lot No / Grade</th>
            <th class="mono">Balance PCS</th>
            <th class="mono">Balance CTS</th>
            <th class="mono">Balance Amount</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="totals-bar" id="balTotals">
      <span class="pill-sum">PCS Balance: <span id="bPCS">0</span></span>
      <span class="pill-sum">CTS Balance: <span id="bCTS">0.00</span></span>
      <span class="pill-sum">Amount Balance: <span id="bAMT">0.00</span></span>
    </div>
  </div>

</div><!-- /.right -->

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDkgQ5BCl8LySoiq5CC-HOWJddnJQQa3jQ",
  authDomain:"poojainventory-ab7fa.firebaseapp.com",
  databaseURL:"https://poojainventory-ab7fa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"poojainventory-ab7fa",
  storageBucket:"poojainventory-ab7fa.firebasestorage.app",
  messagingSenderId:"804100194953",
  appId:"1:804100194953:web:0af84ea1d53c3dde26bc58"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ===== Helpers ===== */
const $=sel=>document.querySelector(sel);
const $$=sel=>[...document.querySelectorAll(sel)];
const byId=id=>document.getElementById(id);
const fmt0=n=>(+(n||0)).toLocaleString(undefined,{maximumFractionDigits:0});
const fmt2=n=>(+(n||0)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const toNum=s=>+String(s||0).toString().replace(/[,()]/g,'')||0;

/* ===== Data ===== */
let movements=[]; // unified rows (ADD positive, SELL negative as requested)
let filtered=[];  // visible after slicers/date
let slicerDefs=[
  {key:'tx', label:'Transaction No'},
  {key:'stone', label:'Stone'},
  {key:'movement', label:'Status'}, // ADD / SELL
  {key:'party', label:'Party'},
  {key:'lot', label:'Lot'},
  {key:'leg', label:'Lot No / Grade'},
  {key:'shape', label:'Shape'},
  {key:'size', label:'Size'}
];
let slicerState={}; // key -> Set(values)

/* ===== Build Slicer UI (Sheets-like) ===== */
function buildSlicers(){
  const bar=byId('slicerBar'); bar.innerHTML='';
  slicerDefs.forEach(def=>{
    const wrap=document.createElement('div'); wrap.className='slicer'; wrap.dataset.key=def.key;
    wrap.innerHTML=`
      <button class="slicer-btn" type="button">${def.label}</button>
      <div class="slicer-menu">
        <div class="slicer-head">
          <input placeholder="Search ${def.label}â€¦">
        </div>
        <div class="slicer-actions">
          <span class="a selall">Select all</span>
          <span class="a clear">Clear</span>
        </div>
        <div class="slicer-list"></div>
        <div class="slicer-foot">
          <button class="btn">Cancel</button>
          <button class="btn primary">Apply</button>
        </div>
      </div>`;
    bar.appendChild(wrap);

    const btn=wrap.querySelector('.slicer-btn');
    const menu=wrap.querySelector('.slicer-menu');
    const list=wrap.querySelector('.slicer-list');
    const inp=wrap.querySelector('input');
    const selAll=wrap.querySelector('.selall');
    const clr=wrap.querySelector('.clear');
    const [btnCancel, btnApply]=wrap.querySelectorAll('.slicer-foot .btn');

    function open(){ closeAll(); wrap.classList.add('open'); renderList(); }
    function close(){ wrap.classList.remove('open'); }
    function renderList(){
      const values=[...new Set(movements.map(m=>m[def.key]).filter(v=>v!=='' && v!==undefined))].sort((a,b)=>String(a).localeCompare(String(b)));
      const q=(inp.value||'').toLowerCase();
      list.innerHTML='';
      const cur=new Set(slicerState[def.key]||[]);
      values
        .filter(v=> String(v).toLowerCase().includes(q))
        .forEach(v=>{
          const row=document.createElement('label'); row.className='slicer-item';
          row.innerHTML=`<input type="checkbox" ${cur.size? (cur.has(String(v))?'checked':'') : 'checked'}> <span>${v}</span>`;
          list.appendChild(row);
        });
    }
    btn.addEventListener('click',open);
    inp.addEventListener('input',renderList);
    selAll.onclick=()=>{ slicerState[def.key]=new Set([...new Set(movements.map(m=>m[def.key]).filter(Boolean))].map(String)); renderList(); };
    clr.onclick=()=>{ slicerState[def.key]=new Set(); renderList(); };
    btnCancel.onclick=close;
    btnApply.onclick=()=>{
      const chosen=[...list.querySelectorAll('input[type=checkbox]')]
        .filter(x=>x.checked).map(x=>x.nextElementSibling.textContent);
      // if user selects nothing => means no filter (show all)
      slicerState[def.key]= new Set(chosen);
      close(); applyFilters();
    };

    // close on outside click
    document.addEventListener('click',e=>{
      if(!wrap.contains(e.target) && !btn.contains(e.target)) close();
    });
  });
}
function closeAll(){ $$('.slicer').forEach(s=>s.classList.remove('open')); }

/* Pills for quick overview / clear per slicer */
function renderPills(){
  const box=byId('pills'); box.innerHTML='';
  slicerDefs.forEach(def=>{
    const cur=[...(slicerState[def.key]||[])];
    if(cur.length && cur.length < new Set(movements.map(m=>m[def.key]).filter(Boolean)).size){
      const pill=document.createElement('span'); pill.className='pill';
      pill.innerHTML = `<b>${def.label}:</b> ${cur.slice(0,3).join(', ')}${cur.length>3?' â€¦':''}<span class="x">Ã—</span>`;
      pill.querySelector('.x').onclick=()=>{ slicerState[def.key]=new Set(); applyFilters(); };
      box.appendChild(pill);
    }
  });
  const d1=byId('f_date_from').value, d2=byId('f_date_to').value;
  if(d1||d2){
    const pill=document.createElement('span'); pill.className='pill';
    pill.innerHTML=`<b>Date:</b> ${d1||'â€¦'} â†’ ${d2||'â€¦'}<span class="x">Ã—</span>`;
    pill.querySelector('.x').onclick=()=>{ byId('f_date_from').value=''; byId('f_date_to').value=''; applyFilters(); };
    box.appendChild(pill);
  }
}

/* ===== Load data (ADD & SELL only) ===== */
async function loadAll(){
  movements=[];

  const [ajAdd, calAdd, ajSell, calSell] = await Promise.all([
    get(ref(db,'/stoneamjz')),
    get(ref(db,'/stonecalibrate')),
    get(ref(db,'/sellAJMZ')),
    get(ref(db,'/sellCalibrate'))
  ]);

  // ADD â€” AJMZ
  if(ajAdd.exists()){
    Object.values(ajAdd.val()).forEach(v=>{
      if(v && v.status==='ADD'){
        movements.push({
          movement:'ADD', stone:'AJMZ',
          tx:v.tx||'', date:v.date||'', party:v.party||'',
          lot:v.lot||'', leg:v.lotno||'', shape:v.shape||'', size:'',
          pcs:+(v.pcs||0), cts:+(v.cts||0), rate:+(v.price||0), amount:+(v.amount||0)
        });
      }
    });
  }
  // ADD â€” CALIBRATE
  if(calAdd.exists()){
    Object.values(calAdd.val()).forEach(v=>{
      if(v && v.status==='ADD'){
        movements.push({
          movement:'ADD', stone:'CALIBRATE',
          tx:v.tx||'', date:v.date||'', party:v.party||'',
          lot:v.lot||'', leg:v.grade||'', shape:v.shape||'', size:v.size||'',
          pcs:0, cts:+(v.cts||0), rate:+(v.price||0), amount:+(v.amount||0)
        });
      }
    });
  }
  // SELL â€” AJMZ (negative display as requested)
  if(ajSell.exists()){
    Object.values(ajSell.val()).forEach(v=>{
      movements.push({
        movement:'SELL', stone:'AJMZ',
        tx:v.tx||v.addTx||'', date:v.date||'', party:v.party||'',
        lot:v.lot||'', leg:v.lotno||'', shape:v.shape||'', size:'',
        pcs:-Math.abs(+(v.pcs||0)), cts:-Math.abs(+(v.cts||0)),
        rate:+(v.price||0), amount:-Math.abs(+(v.amount||0))
      });
    });
  }
  // SELL â€” CALIBRATE
  if(calSell.exists()){
    Object.values(calSell.val()).forEach(v=>{
      movements.push({
        movement:'SELL', stone:'CALIBRATE',
        tx:v.tx||v.addTx||'', date:v.date||'', party:v.party||'',
        lot:v.lot||'', leg:v.grade||'', shape:v.shape||'', size:v.size||'',
        pcs:0, cts:-Math.abs(+(v.cts||0)),
        rate:+(v.price||0), amount:-Math.abs(+(v.amount||0))
      });
    });
  }

  // init slicer state (no restrictions = show all)
  slicerDefs.forEach(d=> slicerState[d.key]=new Set());
  buildSlicers();
  applyFilters();
}

/* ===== Filtering + Rendering ===== */
function passSlicers(r){
  for(const def of slicerDefs){
    const sel=slicerState[def.key];
    if(sel && sel.size){
      if(!sel.has(String(r[def.key]??''))) return false;
    }
  }
  return true;
}
function passDate(r){
  const d1=byId('f_date_from').value;
  const d2=byId('f_date_to').value;
  if(d1 && (r.date||'')<d1) return false;
  if(d2 && (r.date||'')>d2) return false;
  return true;
}
function applyFilters(){
  filtered = movements.filter(r=> passSlicers(r) && passDate(r) );
  renderPills();
  renderLedger();
  renderBalances();
}

function renderLedger(){
  const body=byId('tblMov').querySelector('tbody');
  const rows=[...filtered].sort((a,b)=>(a.date||'').localeCompare(b.date||'') || (a.tx||'').localeCompare(b.tx||''));
  body.innerHTML = rows.map(r=>`
    <tr class="${r.movement==='SELL'?'sell':'add'}">
      <td>${r.movement}</td>
      <td>${r.stone}</td>
      <td>${r.tx}</td>
      <td>${r.date}</td>
      <td>${r.party}</td>
      <td>${r.lot}</td>
      <td>${r.leg}</td>
      <td>${r.shape}</td>
      <td>${r.size||''}</td>
      <td class="mono">${fmt0(Math.abs(r.pcs))}</td>
      <td class="mono">${fmt2(Math.abs(r.cts))}</td>
      <td class="mono">${r.rate?fmt2(r.rate):''}</td>
      <td class="mono">${fmt2(Math.abs(r.amount))}</td>
    </tr>
  `).join('');

  // Visible-only subtotals
  const tPCS = rows.reduce((s,r)=>s + (+r.pcs||0),0);
  const tCTS = rows.reduce((s,r)=>s + (+r.cts||0),0);
  const tAMT = rows.reduce((s,r)=>s + (+r.amount||0),0);
  byId('sumPCS').textContent=fmt0(tPCS);
  byId('sumCTS').textContent=fmt2(tCTS);
  byId('sumAMT').textContent=fmt2(tAMT);
}

function renderBalances(){
  // Group by Stone + Lot + LotNo/Grade (visible rows only)
  const map = new Map();
  for(const r of filtered){
    const k = `${r.stone}||${r.lot}||${r.leg}`;
    const o = map.get(k)||{stone:r.stone, lot:r.lot, leg:r.leg, pcs:0, cts:0, amt:0};
    o.pcs += (+r.pcs||0);
    o.cts += (+r.cts||0);
    o.amt += (+r.amount||0);
    map.set(k,o);
  }
  const rows = [...map.values()].sort((a,b)=>(a.stone+a.lot+a.leg).localeCompare(b.stone+b.lot+b.leg));
  const body=byId('tblBal').querySelector('tbody');
  body.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.stone}</td>
      <td>${r.lot}</td>
      <td>${r.leg}</td>
      <td class="mono">${fmt0(r.pcs)}</td>
      <td class="mono">${fmt2(r.cts)}</td>
      <td class="mono">${fmt2(r.amt)}</td>
    </tr>
  `).join('');

  // Visible-only balance totals
  const bPCS = rows.reduce((s,r)=>s + (+r.pcs||0),0);
  const bCTS = rows.reduce((s,r)=>s + (+r.cts||0),0);
  const bAMT = rows.reduce((s,r)=>s + (+r.amt||0),0);
  byId('bPCS').textContent=fmt0(bPCS);
  byId('bCTS').textContent=fmt2(bCTS);
  byId('bAMT').textContent=fmt2(bAMT);
}

/* ===== Buttons ===== */
byId('btnClear').onclick=()=>{
  slicerDefs.forEach(d=> slicerState[d.key]=new Set());
  byId('f_date_from').value=''; byId('f_date_to').value='';
  applyFilters();
};
byId('btnExport').onclick=()=>{
  const header=['Movement','Stone','Transaction No','Date','Party','Lot','Lot No / Grade','Shape','Size','PCS','CTS','Rate','Amount'];
  const data = [header].concat(filtered.map(r=>[
    r.movement,r.stone,r.tx,r.date,r.party,r.lot,r.leg,r.shape,r.size,(+r.pcs||0),(+r.cts||0),(+r.rate||0),(+r.amount||0)
  ]));
  const csv = data.map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`inventory-report-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
};
byId('btnPrint').onclick=()=>window.print();

byId('f_date_from').addEventListener('change',applyFilters);
byId('f_date_to').addEventListener('change',applyFilters);

/* Boot */
loadAll();
</script>
</body>
</html>
